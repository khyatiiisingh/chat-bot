name: Deploy to EC2 üöÄ
on:
  push:
    branches:
      - "main" # Trigger on push to main branch
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch ‚úÖ
        uses: actions/checkout@v2

      - name: Debug - List files in repository
        run: ls -la

      - name: Set up SSH key and whitelist EC2 IP address üêª‚Äç‚ùÑÔ∏è
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          # Test SSH connection to make sure it works
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "echo SSH connection successful"

      - name: Create requirements.txt üì¶
        run: |
          cat > requirements.txt << 'EOF'
          streamlit==1.26.0
          langchain==0.0.329
          langchain_google_genai==0.0.5
          langchain_community==0.0.10
          faiss-cpu==1.7.4
          python-dotenv==1.0.0
          fastapi==0.103.1
          uvicorn==0.23.2
          gunicorn==21.2.0
          flask==2.3.3
          pydantic==2.3.0
          EOF

      - name: Create test app.py if not exists
        run: |
          if [ ! -f app.py ]; then
            echo "Creating test app.py"
            cat > app.py << 'EOF'
          from fastapi import FastAPI

          api = FastAPI()

          @api.get("/")
          def read_root():
              return {"message": "API is running. This is a test deployment."}

          @api.get("/health")
          def health_check():
              return {"status": "healthy"}
          EOF
          fi

          if [ ! -f transcription.py ]; then
            echo "Creating test transcription.py"
            cat > transcription.py << 'EOF'
          def transcribe_audio(file_path):
              """Placeholder function for audio transcription"""
              return "This is a sample transcription text."
          EOF
          fi

      - name: Create .env file dynamically üß®
        env:
          ENV: ${{ secrets.ENV }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          GOOGLE_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ENV=${ENV:-production}" >> env
          echo "EC2_USERNAME=${EC2_USERNAME}" >> env
          echo "GOOGLE_API_KEY=${GOOGLE_API_KEY}" >> env

      - name: Create deploy.sh script üöÄ
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e  # Exit immediately if a command exits with a non-zero status

          echo "=== Starting deployment process ==="

          # Create destination directory with proper permissions
          echo "Setting up app directory"
          sudo mkdir -p /var/www/langchain-app
          sudo chown $(whoami):$(whoami) /var/www/langchain-app

          # Copy deployment files to a temporary location first
          echo "Copying files to temporary location"
          mkdir -p ~/deployment_temp
          cp -r * ~/deployment_temp/

          # Save any existing logs if present
          if [ -f /var/www/langchain-app/gunicorn.log ]; then
            echo "Preserving existing logs"
            sudo cp /var/www/langchain-app/gunicorn.log ~/gunicorn.log.backup
          fi

          echo "Removing old app"
          sudo rm -rf /var/www/langchain-app/*

          echo "Moving files to app folder"
          sudo cp -r ~/deployment_temp/* /var/www/langchain-app/
          sudo chown -R $(whoami):$(whoami) /var/www/langchain-app

          # Navigate to the app directory
          cd /var/www/langchain-app/

          # Ensure the .env file exists
          if [ -f env ]; then
              sudo mv env .env
              echo ".env file created from env"
          else
              echo "WARNING: env file not found, creating empty .env"
              touch .env
          fi

          # Update system packages
          echo "Updating system packages"
          sudo apt-get update

          echo "Installing python and pip"
          sudo apt-get install -y python3 python3-pip python3-dev

          # Install application dependencies from requirements.txt
          echo "Installing application dependencies from requirements.txt"
          if [ -f requirements.txt ]; then
              sudo pip3 install -r requirements.txt
          else
              echo "WARNING: requirements.txt not found, installing essential packages"
              sudo pip3 install streamlit langchain langchain_google_genai langchain_community faiss-cpu python-dotenv fastapi uvicorn gunicorn pydantic
          fi

          # Create sample transcript if not exists
          if [ ! -f cleaned_transcript.txt ]; then
              echo "Creating sample transcript file"
              echo "Welcome to today's lecture on Artificial Intelligence and Machine Learning." > cleaned_transcript.txt
              echo "This is a sample transcript file created during deployment." >> cleaned_transcript.txt
          fi

          # Update and install Nginx if not already installed
          if ! command -v nginx > /dev/null; then
              echo "Installing Nginx"
              sudo apt-get update
              sudo apt-get install -y nginx
          fi

          # Configure Nginx to use HTTP instead of Unix socket
          echo "Configuring Nginx for HTTP proxy"
          sudo bash -c 'cat > /etc/nginx/sites-available/myapp <<EOF
          server {
              listen 80;
              server_name _;
              
              location / {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF'

          # Enable the site
          sudo ln -sf /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled
          sudo rm -f /etc/nginx/sites-enabled/default

          # Validate nginx config
          echo "Validating Nginx configuration"
          sudo nginx -t

          # Restart Nginx
          echo "Restarting Nginx"
          sudo systemctl restart nginx

          # Stop any existing Gunicorn processes
          echo "Stopping any existing Gunicorn processes"
          sudo pkill gunicorn || true

          # Create a minimal test app.py if needed
          if [ ! -f app.py ]; then
              echo "WARNING: app.py not found, creating test version"
              cat > app.py <<EOF
          from fastapi import FastAPI

          api = FastAPI()

          @api.get("/")
          def read_root():
              return {"message": "API is running. This is a test deployment."}

          @api.get("/health")
          def health_check():
              return {"status": "healthy"}
          EOF
          fi

          echo "Directory contents:"
          ls -la

          # Start Gunicorn with HTTP binding (not Unix socket)
          echo "Starting Gunicorn with HTTP binding"
          cd /var/www/langchain-app/
          nohup sudo gunicorn --workers 3 --bind 0.0.0.0:8000 app:api --timeout 120 > gunicorn.log 2>&1 &

          # Give Gunicorn time to start
          echo "Waiting for Gunicorn to start..."
          sleep 10

          # Verify the app is running
          echo "Verifying application is running"
          if curl -s http://127.0.0.1:8000/; then
              echo "‚úÖ Application is running successfully!"
          else
              echo "‚ö†Ô∏è WARNING: Application is not responding on port 8000"
              echo "Checking logs for errors:"
              tail -n 50 gunicorn.log
          fi

          echo "=== Deployment complete ==="
          echo "Check application logs at: /var/www/langchain-app/gunicorn.log"
          EOF
          chmod +x deploy.sh

      - name: Copy files to remote server üöô
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "Files to copy:"
          ls -la

          echo "Copying files to remote server"
          scp -r app.py transcription.py requirements.txt env deploy.sh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/

      - name: Run Bash Script To Deploy App üöÄ
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "chmod +x ./deploy.sh && ./deploy.sh"

      - name: Clean up SSH key üöÄ
        if: always()
        run: rm -f ~/.ssh/id_rsa
